import "../assets/fonts/Inter-VariableFont_opsz,wght.ttf";

import { Button, TabWidget, Palette, StandardButton } from "std-widgets.slint";
import { EditorTab, EditorTabs } from "editor-tab.slint";
import { VirtualConsoleTab } from "virtual-console-tab.slint";
import { Preview2D } from "views/preview-2d.slint";
import { FadersView } from "views/faders-view.slint";
import {
    Icons,
    BorderHorz,
    BorderVert,
    Theme,
} from "styling.slint";
import { TimeLineTab } from "timeline-tab.slint";
import { ToolTipArea } from "parts/tooltip.slint";
import { TitleBar } from "titlebar.slint";
import { MiddleText } from "parts/texts.slint";
import { LeftPanel } from "panel-left.slint";
import { Preview3D } from "views/preview-3d.slint";
import { GlobalMessage } from "global-state.slint";

export { Preview2DStore } from "./views/preview-2d.slint";
export { FadersStore } from "./views/faders-view.slint";
export { FixtureListStore } from "./containers/fixture-def-panel.slint";
export { UniverseViewStore } from "./views/universe-view.slint";

export global MenuBarActions {
    callback save();
    callback save-as();
}

enum TopLevelTabs{
    Editor,
    Timeline,
    VirtualConsole
}

export component AppWindow inherits Window {
    title: "Tsukuyomi";
    icon: Icons.default;
    no-frame: true;
    full-screen: true;
    default-font-family: "Inter";

    property <bool> show-save-dialog;
    property <string> error-message <=> GlobalMessage.error-message;
    in property <image> texture;
    out property <TopLevelTabs> current-tab: index-to-tabs-enum(main-pane.current-index);
    out property <EditorTabs> editor-tab-current-index: editor-tab.current-index;

    callback start_drag();
    callback minimize();
    callback toggle-fullscreen();
    callback close();

    pure function index-to-tabs-enum(index: int) -> TopLevelTabs {
        if index == 0 {
            return TopLevelTabs.Editor;
        }
        if index == 1 {
            return TopLevelTabs.Timeline;
        }
        if index == 2 {
            return TopLevelTabs.VirtualConsole;
        }
        debug("tabs-enum: unknown index");
        return TopLevelTabs.Editor;
    }

    if Platform.os == OperatingSystemType.macos:MenuBar {
        Menu {
            title: @tr("File");
            MenuItem {
                title: @tr("New");
                activated => {
                };
            }

            MenuItem {
                title: @tr("Open");
                activated => {
                };
            }

            MenuItem {
                title: @tr("Open Recentry");
                activated => {
                };
            }

            MenuSeparator { }

            MenuItem {
                title: @tr("Save");
                activated => {
                    show-save-dialog = true;
                };
            }

            MenuItem {
                title: @tr("Save As");
                activated => {
                };
            }
        }

        Menu {
            title: @tr("Edit");
            MenuItem {
                title: @tr("Undo");
                activated => {
                };
            }

            MenuItem {
                title: @tr("Redo");
                activated => {
                };
            }

            MenuItem {
                title: @tr("Copy");
                activated => {
                };
            }

            MenuItem {
                title: @tr("Paste");
                activated => {
                };
            }
        }

        Menu {
            title: @tr("Help");
            MenuItem {
                title: @tr("About");
                activated => {
                };
            }
        }
    }

    visual-elements := VerticalLayout {
        if Platform.os != OperatingSystemType.macos:title-bar := VerticalLayout {
            TitleBar {
                height: 32px;
                minimize => root.minimize();
                toggle-fullscreen => root.toggle-fullscreen();
                close => root.close();
                show-tooltip(has-hover, x, y, msg) => tooltip.show-tooltip(has-hover, x, y, msg);
                //TODO: バケツリレー
            }

            BorderHorz { }
        }

        content := HorizontalLayout {
            left := LeftPanel {
                //width: self.is-expanded ? content.width * 0.25 : 52px;
                // FIXME: hard code
                show-tooltip(has-hover, x, y, msg) => tooltip.show-tooltip(has-hover, x, y, msg);
            }

            BorderVert { }

            center := VerticalLayout {
                main-pane := TabWidget {
                    //height: 70%;
                    Tab {
                        title: @tr("Editor");
                        editor-tab := EditorTab {
                            texture: root.texture;
                            // FIXME: バケツリレー
                        }
                    }

                    Tab {
                        title: @tr("TimeLine");
                        TimeLineTab { }
                    }

                    Tab {
                        title: @tr("Virtual Console");
                        VirtualConsoleTab { }
                    }
                }

                BorderHorz { }

                bottom-panel := HorizontalLayout {
                    //height: 30%;
                    //HorizontalSplit {}

                    Rectangle {
                        Text {
                            text: "something?";
                        }
                    }

                    BorderVert { }

                    FadersView { }
                }
            }
        }
    }

    /*TouchArea {
        moved => {
            root.start_drag();
        }
    }*/

    save-dialog := Dialog {
        visible: root.show-save-dialog;
        MiddleText {
            text: @tr("Do you want to save before exit?");
        }

        StandardButton {
            kind: StandardButtonKind.yes;
        }

        StandardButton {
            kind: StandardButtonKind.no;
        }

        StandardButton {
            kind: StandardButtonKind.cancel;
            clicked => {
                save-dialog.visible = false;
            }
        }
    }

    error-dialog := Dialog {
        visible: root.error-message != "";
        MiddleText {
            text: root.error-message;
        }

        StandardButton {
            kind: StandardButtonKind.ok;
            clicked => {
                root.error-message = "";
            }
        }
    }

    tooltip := ToolTipArea { }
}
